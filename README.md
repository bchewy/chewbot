# ChewBot - AI Assistant & Anonymizer for Telegram

ChewBot is a versatile Telegram bot designed to enhance discussion groups linked to a main channel. It automatically provides AI-powered explanations for channel posts, generates relevant search links, allows manual explanation/summarization, and anonymizes user comments within the discussion groups.

## Key Features

-   **Automatic Post Explanation:** When a post (text or image with caption) from the designated main channel is forwarded to a linked discussion group, the bot automatically provides a concise explanation generated by Google Gemini.
-   **Perplexity Search Links:** Alongside explanations, the bot generates a Perplexity.ai search link based on the post's content for deeper exploration.
-   **Anonymized Discussion:** All user messages (text, photos with captions, stickers) sent directly within the configured discussion groups are automatically anonymized. The bot deletes the original message and reposts it under a randomly assigned "Chew" alias (e.g., "Chewer ü¶∑", "Chewy üç¨"). Each user gets a consistent alias within the group.
-   **Manual Commands (Anonymized):**
    -   `/explain`: Reply to any message in a discussion group with this command to get a detailed explanation from the AI. The command itself is deleted for anonymity.
    -   `/summarise`: Reply to any message in a discussion group with this command to get a concise summary from the AI. The command itself is deleted for anonymity.
-   **Configurable:** Set up your Telegram token, Gemini API key, main channel ID, and discussion group IDs via an environment file.
-   **JSON Logging:** Bot actions and errors are logged to `bot.log` in JSON format.

## How it Works

1.  **Auto-Explanation:** The bot listens for new posts in the `MAIN_CHANNEL_ID`. When a post is made, it generates an explanation and a Perplexity query using the Gemini API.
2.  **Forward Trigger:** When that specific channel post is forwarded by a user into one of the `DISCUSSION_GROUP_IDS`, the bot detects the forward, retrieves the pre-generated explanation and query, formats them (including the Perplexity link), and replies to the forwarded message in the discussion group.
3.  **Anonymization:** The bot listens for any regular messages (not commands, not forwards, not from itself) in the `DISCUSSION_GROUP_IDS`. When a user sends a message, the bot:
    *   Assigns a persistent anonymous "Chew" name to the user if they don't have one.
    *   Deletes the user's original message.
    *   Reposts the message content (text, photo+caption, sticker) prefixed with the user's anonymous name (e.g., `[Chewbert ü§ñ]: Hello!`).
4.  **Manual Commands:** When a user replies to a message with `/explain` or `/summarise` in a discussion group:
    *   The bot deletes the user's command message.
    *   It sends the target message content to the Gemini API using the appropriate prompt.
    *   It replies to the *original* target message with the AI-generated explanation or summary.

## Requirements

-   Python 3.7+
-   Telegram Bot API token
-   Google Gemini API key
-   Accounts on Telegram and Google AI Studio (or wherever you get the Gemini key).

## Installation

```bash
# 1. Clone the repository
git clone <your-repo-url> # Replace with your repository URL
cd <repository-folder-name>

# 2. Install dependencies
pip install -r requirements.txt
```

## Configuration

Create a file named `.env` in the project's root directory and add the following variables:

```dotenv
# Your Telegram Bot Token from @BotFather
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here

# Your Google Gemini API Key
GEMINI_API_KEY=your_gemini_api_key_here

# The ID of your main Telegram channel (e.g., -1001234567890)
MAIN_CHANNEL_ID=your_main_channel_id_here

# Comma-separated list of discussion group IDs linked to the channel
# (e.g., -1009876543210,-1001122334455)
DISCUSSION_GROUP_IDS=group_id1,group_id2,group_id3
```

**How to find IDs:**

-   **Channel/Group ID:** You can use bots like `@RawDataBot` or `@getidsbot`. Forward a message from the channel/group to the ID bot to get the chat ID. Public channels might use `@channelusername`, but private ones need the numeric ID (usually starting with `-100`).

## Usage

1.  **Create Bot:** Create a new bot using `@BotFather` on Telegram.
2.  **Disable Privacy Mode:** Crucially, **disable** group privacy mode for your bot via `@BotFather` (`/mybots` -> select bot -> Bot Settings -> Group Privacy -> Turn off). This allows the bot to see all messages in the discussion groups, which is necessary for anonymization and command handling.
3.  **Add Bot:**
    *   Add the bot as an **administrator** to your main channel (`MAIN_CHANNEL_ID`). Permissions needed: *Read messages*.
    *   Add the bot as an **administrator** to **all** your discussion groups (`DISCUSSION_GROUP_IDS`). Permissions needed: *Read messages*, *Delete messages* (for anonymization and command cleanup).
4.  **Run the Bot:**
    ```bash
    python bot.py
    ```
5.  **Functionality:**
    *   Posts in the main channel will trigger background explanation generation.
    *   Forwarding those posts to discussion groups will trigger the bot's explanation reply.
    *   Sending messages directly in discussion groups will trigger anonymization.
    *   Replying with `/explain` or `/summarise` in discussion groups will trigger the respective AI actions.

## Logging

The bot logs activities and errors to `bot.log` in the same directory, using JSON format for structured logging.

## Important Notes

-   **Privacy Mode:** Ensure Group Privacy Mode is **disabled** for the bot. Otherwise, it won't be able to see user messages in groups unless directly mentioned or replying to its own messages, breaking the anonymization and command features.
-   **Admin Permissions:** The bot needs admin rights (specifically delete messages) in the discussion groups for the anonymization feature to work correctly.
-   **API Keys:** Keep your `.env` file secure and do not commit it to version control. Add `.env` to your `.gitignore` file.
